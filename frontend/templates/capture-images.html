<!DOCTYPE html>
<html class="light" lang="es">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Entrenamiento de Gestos - Sign Language AI</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@100..900&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
        <script src="../js/custom-alert.js"></script>
    <script>(function(){if(localStorage.getItem('theme')==='dark'){document.documentElement.classList.add('dark');}})();</script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#0df259",
                        "background-light": "#f5f8f6",
                        "background-dark": "#102216",
                    },
                    fontFamily: {
                        "display": ["Lexend", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.5rem",
                        "lg": "1rem",
                        "xl": "1.5rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
    <style>
        body {
            font-family: 'Lexend', sans-serif;
        }
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .notification {
            background-color: #0df259;
            color: #0d1c12;
            padding: 12px 24px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(13, 242, 89, 0.3);
            animation: fadeOut 3s forwards;
            font-weight: 600;
        }
        @keyframes fadeOut {
            0% { opacity: 1; }
            80% { opacity: 1; }
            100% { opacity: 0; transform: translateY(-20px); }
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark min-h-screen transition-colors duration-300">
<div class="flex flex-col min-h-screen w-full">
    <!-- Top Navigation Bar unificado -->
    <header class="flex flex-wrap items-center gap-4 justify-between border-b border-[#e7f4eb] dark:border-white/10 px-6 lg:px-10 py-4 bg-white/80 dark:bg-background-dark/80 backdrop-blur-md sticky top-0 z-50">
        <div class="flex items-center gap-3 text-[#0d1c12] dark:text-white">
            <div class="size-8 bg-primary/20 rounded-xl flex items-center justify-center text-primary">
                <span class="material-symbols-outlined">sign_language</span>
            </div>
            <div>
                <p class="text-xs text-gray-500 dark:text-gray-400">Módulo</p>
                <h2 class="text-lg font-bold leading-tight tracking-tight">Captura de Gestos</h2>
            </div>
        </div>
        <nav class="flex items-center flex-wrap gap-2 text-sm font-semibold text-[#0d1c12] dark:text-gray-200">
            <button onclick="goHome()" class="px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-white/5">Inicio</button>
            <button onclick="goToDictionary()" class="px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-white/5">Diccionario</button>
            <button class="px-3 py-2 rounded-lg bg-primary/10 text-primary font-bold">Captura</button>
            <button onclick="goToTranslator()" class="px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-white/5">Visualización</button>
        </nav>
        <div class="flex items-center gap-3 ml-auto">
            <button id="loginBtn" onclick="goToLoginPage()" class="hidden flex items-center gap-2 px-4 h-10 rounded-xl bg-white dark:bg-white/5 border border-gray-200 dark:border-gray-700 text-sm font-semibold hover:bg-gray-50 dark:hover:bg-white/10">
                <span class="material-symbols-outlined text-base">login</span>
                <span>Iniciar sesión</span>
            </button>
            <div id="userSection" class="hidden flex items-center gap-3">
                <span class="text-sm text-gray-600 dark:text-gray-300">Hola, <span id="userName" class="font-bold text-primary"></span></span>
                <button onclick="logout()" class="flex items-center gap-1 px-4 h-10 rounded-xl bg-red-500/10 text-red-600 dark:text-red-400 text-sm font-semibold hover:bg-red-500/20">
                    <span class="material-symbols-outlined text-base">logout</span>
                    <span>Cerrar sesión</span>
                </button>
            </div>
            <button onclick="stopCaptureAndNavigate()" class="flex items-center justify-center rounded-xl h-10 w-10 bg-[#e7f4eb] dark:bg-white/10 text-[#0d1c12] dark:text-white hover:bg-primary/20 transition-colors">
                <span class="material-symbols-outlined text-xl">home</span>
            </button>
        </div>
    </header>

    <main class="flex-1 max-w-[1280px] mx-auto w-full px-6 py-8">
        <!-- Breadcrumbs -->
        <div class="flex flex-wrap items-center gap-2 mb-4">
            <a class="text-[#499c65] dark:text-primary/70 text-sm font-medium" href="index.html">Entrenamiento</a>
            <span class="text-[#499c65] dark:text-primary/70 text-sm material-symbols-outlined">chevron_right</span>
            <span class="text-[#0d1c12] dark:text-white text-sm font-medium">Capturar Imágenes</span>
        </div>

        <!-- Page Heading -->
        <div class="flex flex-col gap-2 mb-8">
            <h1 class="text-[#0d1c12] dark:text-white text-4xl font-black leading-tight tracking-tight">Captura de Imágenes</h1>
            <p class="text-[#499c65] dark:text-gray-400 text-base font-normal">Realiza los gestos frente a la cámara para alimentar el modelo en tiempo real.</p>
        </div>

        <!-- Workspace Layout -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left: Video Feed & Controls (2/3) -->
            <div class="lg:col-span-2 flex flex-col gap-6">
                <!-- Media Player Container -->
                <div class="bg-white dark:bg-background-dark border border-[#cee8d7] dark:border-white/10 rounded-xl overflow-hidden shadow-sm">
                    <div class="relative flex items-center justify-center bg-gray-200 dark:bg-gray-800 aspect-video group">
                        <!-- Video Feed -->
                        <img id="videoFeed" src="" alt="Video feed" class="absolute inset-0 w-full h-full object-cover"/>
                    </div>
                </div>

                <!-- Input Controls Area -->
                <div class="bg-white dark:bg-background-dark p-6 rounded-xl border border-[#cee8d7] dark:border-white/10 shadow-sm">
                    <div class="flex flex-col md:flex-row items-end gap-6">
                        <label class="flex flex-col flex-1 min-w-40">
                            <p class="text-[#0d1c12] dark:text-gray-200 text-sm font-semibold pb-2">Letra a entrenar</p>
                            <input id="gestureLetter" type="text" maxlength="1" class="form-input w-full rounded-xl text-[#0d1c12] dark:text-white border-[#cee8d7] dark:border-white/20 bg-transparent focus:ring-primary focus:border-primary h-14 px-4 text-xl font-bold uppercase" placeholder="Ej: A"/>
                        </label>
                        <div class="flex flex-col flex-1 min-w-40">
                            <p class="text-[#0d1c12] dark:text-gray-200 text-sm font-semibold pb-2">Imágenes capturadas</p>
                            <div class="flex items-center justify-between h-14 px-4 rounded-xl border border-[#cee8d7] dark:border-white/20 bg-background-light dark:bg-white/5">
                                <span id="counterValue" class="text-2xl font-black text-primary">0</span>
                                <span class="text-xs text-[#499c65] dark:text-primary/70 font-medium">LETRA: <span id="currentLetterSmall">-</span></span>
                            </div>
                        </div>
                        <button onclick="captureImage()" class="flex-1 h-14 bg-primary hover:bg-[#0bc148] text-[#0d1c12] font-black text-lg rounded-xl transition-all shadow-md active:scale-95 flex items-center justify-center gap-2 px-8">
                            <span class="material-symbols-outlined">add_a_photo</span>
                            CAPTURAR GESTO
                        </button>
                    </div>
                </div>
            </div>

            <!-- Right: Reference Panel (1/3) -->
            <div class="flex flex-col gap-6">
                <!-- Reference Example Card -->
                <div class="bg-white dark:bg-background-dark p-6 rounded-xl border border-[#cee8d7] dark:border-white/10 shadow-sm h-full flex flex-col">
                    <div class="flex items-center gap-2 mb-6 text-primary">
                        <span class="material-symbols-outlined">lightbulb</span>
                        <h3 class="font-bold text-[#0d1c12] dark:text-white uppercase tracking-wider text-sm">Ejemplo de gesto</h3>
                    </div>
                    
                    <!-- Gesture Reference Image -->
                    <div class="rounded-xl bg-[#f8fcf9] dark:bg-white/5 border border-dashed border-[#499c65] dark:border-primary/30 p-4 mb-6 min-h-[200px] flex items-center justify-center">
                        <img id="exampleImage" alt="Ejemplo de gesto" class="w-full h-auto rounded-lg grayscale hover:grayscale-0 transition-all duration-500" style="display: none;"/>
                        <div id="noExampleMsg" class="text-[#499c65] dark:text-gray-500 text-sm italic">Ingresa una letra para ver el ejemplo</div>
                    </div>
                    
                    <div class="flex-1 flex flex-col items-center justify-center">
                        <p class="text-xs font-bold text-[#499c65] uppercase mb-1">Letra actual</p>
                        <span id="currentLetter" class="text-9xl font-black text-[#0d1c12] dark:text-white">-</span>
                    </div>
                    
                    <div id="gestureDescription" class="mt-8 p-4 bg-primary/10 rounded-xl border border-primary/20" style="display: none;">
                        <p class="text-[#0d1c12] dark:text-gray-300 text-xs leading-relaxed italic">
                            Realiza el gesto correspondiente a la letra seleccionada.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation Bar -->
        <div class="mt-12 flex items-center justify-between border-t border-[#e7f4eb] dark:border-white/10 pt-8 pb-12">
            <button onclick="stopCaptureAndNavigate()" class="px-8 py-3 rounded-xl border-2 border-[#cee8d7] dark:border-white/20 text-[#499c65] dark:text-gray-300 font-bold hover:bg-[#e7f4eb] dark:hover:bg-white/5 transition-colors flex items-center gap-2">
                <span class="material-symbols-outlined">arrow_back</span>
                REGRESAR
            </button>
            <div class="flex gap-4">
                <button onclick="trainModel()" class="px-8 py-3 rounded-xl bg-primary text-[#0d1c12] font-black hover:bg-[#0bc148] transition-all shadow-lg flex items-center gap-2">
                    <span class="material-symbols-outlined">model_training</span>
                    ENTRENAR MODELO
                </button>
            </div>
        </div>
    </main>
</div>

<!-- Notification Container -->
<div class="notification-container" id="notificationContainer"></div>
    <script src="/js/dashboard.js"></script>
    <script>
        const userId = new URLSearchParams(window.location.search).get('userId') || localStorage.getItem('userId');
        let captureServiceStarted = false;
        let isStreaming = false;
        const validLetters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';

        function checkAuth() {
            const uid = localStorage.getItem('userId');
            const uname = localStorage.getItem('userName');
            const loginBtn = document.getElementById('loginBtn');
            const userSection = document.getElementById('userSection');
            const nameSpan = document.getElementById('userName');

            if (uid && uname) {
                loginBtn.classList.add('hidden');
                userSection.classList.remove('hidden');
                nameSpan.textContent = uname;
            } else {
                loginBtn.classList.remove('hidden');
                userSection.classList.add('hidden');
            }
        }

        function goHome(){ window.location.href = 'index.html'; }
        function goToLoginPage(){ window.location.href = 'inicio-sesion.html'; }
        function goToDictionary(){ window.location.href = 'diccionario.html'; }
        function goToTranslator(){
            const uid = localStorage.getItem('userId');
            if (!uid) {
                showCustomAlert('Inicia sesión para usar el traductor', 'warning');
                setTimeout(()=>window.location.href='inicio-sesion.html',1200);
                return;
            }
            window.location.href = `visualize-model.html?userId=${uid}`;
        }
        function logout(){
            localStorage.removeItem('userId');
            localStorage.removeItem('userName');
            checkAuth();
            showCustomAlert('Sesión cerrada', 'success');
        }

        // Start the capture service and set up video feed
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            if (!userId) {
                showNotification('ID de usuario no encontrado. Por favor, inicie sesión de nuevo.');
                return;
            }
            
            // Setup input validation
            const letterInput = document.getElementById('gestureLetter');
            letterInput.addEventListener('input', (e) => {
                let value = e.target.value.toUpperCase();
                // Solo mantener caracteres válidos
                value = value.split('').filter(char => validLetters.includes(char)).join('');
                // Solo una letra
                if (value.length > 1) {
                    value = value.slice(-1);
                }
                e.target.value = value;
                updateExampleImage(value);
            });
            
            // Load initial image counter
            updateCaptureCounter();
            
            // Ensure recognition camera is closed, then open capture camera
            showNotification('Preparando cámara de captura...');
            fetch(`/api/python/recognition-camera/close`, { method: 'POST' })
                .finally(() => {
                    fetch(`/api/python/capture-camera/open`, { method: 'POST' })
                        .then(() => {
                            showNotification('Cámara de captura lista. Iniciando stream...');
                            setTimeout(() => { loadVideoFeed(); }, 800);
                        })
                        .catch(() => {
                            showNotification('No se pudo abrir la cámara de captura.');
                        });
                });

            // Stop capture service when leaving the page
            const closeCapture = () => fetch(`/api/python/capture-camera/close`, { method: 'POST' }).catch(() => {});
            window.addEventListener('beforeunload', closeCapture);
            window.addEventListener('pagehide', closeCapture);
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) closeCapture();
            });
        });

        function updateExampleImage(letter) {
            const exampleImg = document.getElementById('exampleImage');
            const noExampleMsg = document.getElementById('noExampleMsg');
            const letterDisplay = document.getElementById('currentLetter');
            const letterSmall = document.getElementById('currentLetterSmall');
            const gestureDesc = document.getElementById('gestureDescription');
            
            if (letter && validLetters.includes(letter)) {
                // Try different filename patterns
                const imagePatterns = [
                    `/static/Letras/Ejemplo-${letter}.jpg`,
                    `/static/Letras/Ejemplo-${letter}.png`,
                    `/static/Letras/${letter}.jpg`,
                    `/static/Letras/${letter}.png`
                ];
                
                letterDisplay.textContent = letter;
                letterSmall.textContent = letter;
                exampleImg.style.display = 'block';
                noExampleMsg.style.display = 'none';
                gestureDesc.style.display = 'block';
                
                let patternIndex = 0;
                const tryPattern = () => {
                    if (patternIndex >= imagePatterns.length) {
                        console.warn(`No image found for letter ${letter}`);
                        exampleImg.style.display = 'none';
                        noExampleMsg.style.display = 'block';
                        return;
                    }
                    
                    exampleImg.src = imagePatterns[patternIndex];
                    patternIndex++;
                };
                
                exampleImg.onerror = tryPattern;
                tryPattern();
            } else {
                letterDisplay.textContent = '-';
                letterSmall.textContent = '-';
                exampleImg.style.display = 'none';
                noExampleMsg.style.display = 'block';
                gestureDesc.style.display = 'none';
            }
        }

        function loadVideoFeed() {
            if (isStreaming) return;
            const img = document.getElementById('videoFeed');
            isStreaming = true;
            img.src = `/api/python/capture-video-feed?userId=${userId}&t=${Date.now()}`;
            img.onload = () => {
                console.log('Streaming de captura iniciado');
            };
            img.onerror = () => {
                console.warn('Fallo del stream, reintentando...');
                isStreaming = false;
                setTimeout(loadVideoFeed, 1500);
            };
        }

        function showNotification(message) {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;

            container.appendChild(notification);

            // Remove the notification after 3 seconds
            setTimeout(() => {
                container.removeChild(notification);
            }, 3000);
        }

        function captureImage() {
            const letter = document.getElementById('gestureLetter').value.trim().toUpperCase();

            if (!letter) {
                showNotification('Por favor, ingresa una letra para capturar.');
                return;
            }

            if (!validLetters.includes(letter)) {
                showNotification('Solo se permiten letras de la A a la Z.');
                return;
            }

            if (!userId) {
                showNotification('ID de usuario no encontrado. Por favor, inicie sesión de nuevo.');
                return;
            }

            fetch(`/api/python/capture-image?userId=${userId}&letter=${letter}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(`Imagen para la letra "${letter}" capturada.`);
                    updateCaptureCounter();
                } else {
                    showNotification('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error al capturar la imagen:', error);
                showNotification('Ocurrió un error al capturar la imagen.');
            });
        }

        function updateCaptureCounter() {
            const userId = localStorage.getItem('userId');
            // Make a request to count captured images
            fetch(`/api/python/count-images?userId=${userId}`)
                .then(response => response.json())
                .then(data => {
                    const totalCount = data.total || 0;
                    document.getElementById('counterValue').textContent = totalCount;
                })
                .catch(error => console.warn('Could not update counter:', error));
        }

        function trainModel() {
            if (!userId) {
                showNotification('ID de usuario no encontrado. Por favor, inicie sesión de nuevo.');
                return;
            }

            showNotification('Entrenando modelo... esto puede tomar unos minutos.');

            fetch(`/api/python/train-model?userId=${userId}`, {
                method: 'POST'
            })
                .then(response => {
                    // Handle both 200 and 500 responses
                    return response.json().then(data => ({
                        status: response.status,
                        data: data
                    }));
                })
                .then(({ status, data }) => {
                    if (status === 200 && data.success) {
                        showNotification('¡Modelo entrenado exitosamente!');
                    } else {
                        const errorMsg = data.message || data.error || 'Error desconocido';
                        showNotification('Error: ' + errorMsg);
                        console.error('Training error:', data);
                    }
                })
                .catch(error => {
                    console.error('Error al entrenar el modelo:', error);
                    showNotification('Ocurrió un error al entrenar el modelo: ' + error.message);
                });
        }

        function stopCaptureAndNavigate() {
            fetch(`/api/python/capture-camera/close`, { method: 'POST' })
                .finally(() => { window.location.href = 'index.html'; });
        }
    </script>
</body>
</html>
